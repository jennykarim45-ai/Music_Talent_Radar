name: Music Talent Radar - Collecte Automatique

on:
  schedule:
    - cron: '0 2 * * *'  # Tous les jours √† 2h du matin UTC
  workflow_dispatch:  # Permet d√©clenchement manuel

jobs:
  collect-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # ‚¨ÜÔ∏è Timeout de 90 minutes
    
    permissions:
      contents: write  # Pour pouvoir pousser des commits

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # R√©cup√©rer tout l'historique
      
      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          echo "üì¶ Installation des d√©pendances..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "‚úÖ D√©pendances install√©es"
      
      - name: üìÅ Create data directory
        run: |
          mkdir -p data
          echo "‚úÖ Dossier data cr√©√©"
      
      - name: üîç V√©rifier secrets Spotify
        run: |
          echo "üîë V√©rification des secrets..."
          if [ -z "${{ secrets.SPOTIFY_CLIENT_ID }}" ]; then
            echo "‚ùå SPOTIFY_CLIENT_ID manquant !"
            exit 1
          else
            echo "‚úÖ SPOTIFY_CLIENT_ID pr√©sent"
          fi
          
          if [ -z "${{ secrets.SPOTIFY_CLIENT_SECRET }}" ]; then
            echo "‚ùå SPOTIFY_CLIENT_SECRET manquant !"
            exit 1
          else
            echo "‚úÖ SPOTIFY_CLIENT_SECRET pr√©sent"
          fi
          echo "‚úÖ Secrets OK"
      
      - name: üéµ Collecte et traitement complet
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
        run: |
          echo "üöÄ D√©but du workflow complet..."
          echo "üìÖ Date: $(date +'%Y-%m-%d %H:%M:%S')"
          echo ""
          
          # Workflow complet : collecte + filtrage + import + scoring
          python music_talent_radar.py --all || {
            echo "‚ùå Erreur lors du workflow principal"
            exit 1
          }
          
          echo "‚úÖ Workflow principal termin√©"
      
      - name: üßπ Nettoyage des doublons
        run: |
          echo "üßπ Suppression des doublons de date..."
          if [ -f "utils/clean_doublon.py" ]; then
            python utils/clean_doublon.py || {
              echo "‚ö†Ô∏è Erreur lors du nettoyage (non bloquant)"
            }
            echo "‚úÖ Nettoyage termin√©"
          else
            echo "‚ö†Ô∏è Script clean_doublon.py non trouv√© (ignor√©)"
          fi
      
      - name: ü§ñ G√©n√©ration pr√©dictions ML
        run: |
          echo "ü§ñ G√©n√©ration des pr√©dictions ML..."
          if [ -f "ml_prediction.py" ]; then
            python ml_prediction.py || {
              echo "‚ö†Ô∏è Erreur lors des pr√©dictions ML (non bloquant)"
            }
            echo "‚úÖ Pr√©dictions g√©n√©r√©es"
          else
            echo "‚ö†Ô∏è Script ml_prediction.py non trouv√© (ignor√©)"
          fi
        continue-on-error: true
      
      - name: üîî G√©n√©ration alertes dynamiques
        run: |
          echo "üîî G√©n√©ration des alertes..."
          if [ -f "generer_alertes.py" ]; then
            python generer_alertes.py || {
              echo "‚ö†Ô∏è Erreur lors de la g√©n√©ration d'alertes (non bloquant)"
            }
            echo "‚úÖ Alertes g√©n√©r√©es"
          else
            echo "‚ö†Ô∏è Script generer_alertes.py non trouv√© (ignor√©)"
          fi
        continue-on-error: true
      
      - name: üìä V√©rifier les changements
        id: check_changes
        run: |
          if git diff --quiet data/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Aucun changement d√©tect√©"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changements d√©tect√©s"
            echo ""
            echo "üìÅ Fichiers modifi√©s :"
            git diff --name-only data/
          fi
      
      - name: üíæ Commit & Push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "üíæ Commit des changements..."
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Ajouter tous les fichiers data
          git add data/*.csv data/*.db 2>/dev/null || true
          git add data/ 2>/dev/null || true
          
          # Commit avec message sur une ligne
          COMMIT_DATE=$(date +'%Y-%m-%d %H:%M UTC')
          git commit -m "ü§ñ Collecte automatique ${COMMIT_DATE} - Mise √† jour donn√©es + scores + alertes ML" || {
            echo "‚ö†Ô∏è Rien √† committer (d√©j√† √† jour)"
            exit 0
          }
          
          # Push avec retry
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push; then
              echo "‚úÖ Push r√©ussi !"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Push √©chou√©, retry ${RETRY_COUNT}/${MAX_RETRIES}..."
                sleep 5
              else
                echo "‚ùå Push √©chou√© apr√®s ${MAX_RETRIES} tentatives"
                exit 1
              fi
            fi
          done
      
      - name: üìä R√©sum√© final
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä R√âSUM√â DE LA COLLECTE"
          echo "=========================================="
          echo "üìÖ Date : $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "üêç Python : $(python --version)"
          echo ""
          echo "üìÅ Fichiers dans data/ :"
          ls -lh data/ 2>/dev/null || echo "‚ö†Ô∏è Dossier data/ vide"
          echo ""
          
          if [ -f "data/music_talent_radar_v2.db" ]; then
            echo "üíæ Base de donn√©es :"
            ls -lh data/music_talent_radar_v2.db
            
            # Compter artistes dans la base
            ARTIST_COUNT=$(python -c "import sqlite3; conn = sqlite3.connect('data/music_talent_radar_v2.db'); cursor = conn.cursor(); cursor.execute('SELECT COUNT(*) FROM artistes'); print(cursor.fetchone()[0]); conn.close()" 2>/dev/null || echo "?")
            echo "üé§ Artistes en base : ${ARTIST_COUNT}"
          fi
          
          echo ""
          echo "‚úÖ Workflow termin√©"
          echo "=========================================="
      
      - name: üìß Notification d'√©chec
        if: failure()
        run: |
          echo ""
          echo "‚ùå =========================================="
          echo "‚ùå √âCHEC DE LA COLLECTE AUTOMATIQUE"
          echo "‚ùå =========================================="
          echo ""
          echo "üîç Points de v√©rification :"
          echo ""
          echo "  1Ô∏è‚É£ Secrets GitHub Actions :"
          echo "     ‚Ä¢ SPOTIFY_CLIENT_ID"
          echo "     ‚Ä¢ SPOTIFY_CLIENT_SECRET"
          echo ""
          echo "  2Ô∏è‚É£ Credentials Spotify :"
          echo "     ‚Ä¢ V√©rifiez sur https://developer.spotify.com/dashboard"
          echo "     ‚Ä¢ Client ID et Secret corrects ?"
          echo ""
          echo "  3Ô∏è‚É£ Fichiers requis :"
          echo "     ‚Ä¢ music_talent_radar.py"
          echo "     ‚Ä¢ artist_urls.csv"
          echo "     ‚Ä¢ requirements.txt"
          echo ""
          echo "  4Ô∏è‚É£ Logs d√©taill√©s :"
          echo "     ‚Ä¢ Consultez les logs ci-dessus"
          echo "     ‚Ä¢ Cherchez les erreurs 401 (auth) ou 429 (rate limit)"
          echo ""
          echo "üìß Consultez l'onglet Actions sur GitHub pour plus de d√©tails"
          echo "=========================================="